cmake_minimum_required(VERSION 3.15)
project(vsepr-sim VERSION 2.0.0 LANGUAGES CXX)

# ============================================================================
# Build Options
# ============================================================================
option(BUILD_TESTS "Build test suite" ON)
option(BUILD_APPS "Build applications" ON)
option(BUILD_VIS "Build visualization tools" ON)
option(BUILD_DEMOS "Build demo targets" OFF)

# ============================================================================
# Compiler Settings
# ============================================================================
set(CMAKE_CXX_STANDARD 20)
set(CMAKE_CXX_STANDARD_REQUIRED ON)
set(CMAKE_CXX_EXTENSIONS OFF)

if(CMAKE_CXX_COMPILER_ID MATCHES "GNU|Clang")
    add_compile_options(-Wall -Wextra -pedantic)
elseif(MSVC)
    add_compile_options(/W4)
endif()

# ============================================================================
# Output Directories
# ============================================================================
set(CMAKE_RUNTIME_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/bin)
set(CMAKE_LIBRARY_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)
set(CMAKE_ARCHIVE_OUTPUT_DIRECTORY ${CMAKE_BINARY_DIR}/lib)

# ============================================================================
# Global Include Directories
# ============================================================================
# Note: Old include/ directory deprecated - using modular src/ structure
include_directories(${PROJECT_SOURCE_DIR}/src)
include_directories(${PROJECT_SOURCE_DIR}/include)

# ============================================================================
# External Dependencies
# ============================================================================

# Dear ImGui (for visualization)
if(BUILD_VIS)
    set(IMGUI_DIR ${PROJECT_SOURCE_DIR}/third_party/imgui)
    set(IMGUI_SOURCES
        ${IMGUI_DIR}/imgui.cpp
        ${IMGUI_DIR}/imgui_demo.cpp
        ${IMGUI_DIR}/imgui_draw.cpp
        ${IMGUI_DIR}/imgui_tables.cpp
        ${IMGUI_DIR}/imgui_widgets.cpp
        ${IMGUI_DIR}/backends/imgui_impl_glfw.cpp
        ${IMGUI_DIR}/backends/imgui_impl_opengl3.cpp
    )
    include_directories(${IMGUI_DIR})
    include_directories(${IMGUI_DIR}/backends)
    
    find_package(OpenGL REQUIRED)
    find_package(glfw3 REQUIRED)
    find_package(GLEW REQUIRED)
endif()

# ============================================================================
# Internal Libraries
# ============================================================================

# --- Core Library ---
add_library(vsepr_core INTERFACE)
target_include_directories(vsepr_core INTERFACE src/core)

# --- Simulation Library ---
# Exclude sim_thread.cpp which depends on command_router
file(GLOB SIM_SOURCES src/sim/*.cpp)
list(FILTER SIM_SOURCES EXCLUDE REGEX ".*sim_thread\\.cpp$")
add_library(vsepr_sim STATIC ${SIM_SOURCES})
target_link_libraries(vsepr_sim PUBLIC vsepr_core)
target_include_directories(vsepr_sim PUBLIC src/sim)

# --- Potentials Library ---
add_library(vsepr_pot INTERFACE)
target_include_directories(vsepr_pot INTERFACE src/pot)
target_link_libraries(vsepr_pot INTERFACE vsepr_core)

# --- Box/PBC Library ---
add_library(vsepr_box INTERFACE)
target_include_directories(vsepr_box INTERFACE src/box)
target_link_libraries(vsepr_box INTERFACE vsepr_core)

# --- Neighbor List Library ---
add_library(vsepr_nl INTERFACE)
target_include_directories(vsepr_nl INTERFACE src/nl)
target_link_libraries(vsepr_nl INTERFACE vsepr_core)

# --- Integrators Library ---
add_library(vsepr_int INTERFACE)
target_include_directories(vsepr_int INTERFACE src/int)
target_link_libraries(vsepr_int INTERFACE vsepr_core)

# --- Build System Library (Formula → Molecule) ---
add_library(vsepr_build INTERFACE)
target_include_directories(vsepr_build INTERFACE src/build)
target_link_libraries(vsepr_build INTERFACE vsepr_core vsepr_sim)

# --- I/O Library (XYZ, XYZA formats) ---
add_library(vsepr_io STATIC
    src/io/xyz_format.cpp
)
target_include_directories(vsepr_io PUBLIC include)
target_link_libraries(vsepr_io PUBLIC vsepr_core)

# --- Thermal Pathway Library (.xyzC format with energy transfer) ---
add_library(vsepr_thermal STATIC 
    src/thermal/xyzc_format.cpp
)
target_include_directories(vsepr_thermal PUBLIC include)
target_link_libraries(vsepr_thermal PUBLIC vsepr_core vsepr_io)

# --- API Façade Library (Production app-facing layer) ---
add_library(vsepr_api STATIC
    src/api/io_api.cpp
)
target_include_directories(vsepr_api PUBLIC include)
target_link_libraries(vsepr_api PUBLIC vsepr_core vsepr_io vsepr_thermal vsepr_pot)

# --- Spec Parser Library (DSL & JSON) ---
add_library(spec_parser STATIC src/spec_parser.cpp)
target_include_directories(spec_parser PUBLIC include)
target_link_libraries(spec_parser PUBLIC vsepr_core)

# --- Visualization Library ---
if(BUILD_VIS)
    file(GLOB VIS_SOURCES src/vis/*.cpp)
    # Exclude broken/old versions
    list(REMOVE_ITEM VIS_SOURCES 
        "${CMAKE_SOURCE_DIR}/src/vis/command_parser.cpp.broken"
        "${CMAKE_SOURCE_DIR}/src/vis/command_parser.cpp.old"
    )
    
    # Add sim_thread for visualization support
    add_library(vsepr_vis STATIC 
        ${VIS_SOURCES} 
        ${IMGUI_SOURCES}
        src/sim/sim_thread.cpp
        src/command_router.cpp
    )
    target_link_libraries(vsepr_vis 
        PUBLIC vsepr_core vsepr_sim
        PUBLIC OpenGL::GL glfw GLEW::GLEW
    )
    target_include_directories(vsepr_vis PUBLIC src/vis)
endif()

# ============================================================================
# Applications
# ============================================================================

if(BUILD_APPS)
    # CLI Tool
    add_executable(vsepr-cli apps/vsepr-cli/main.cpp)
    target_link_libraries(vsepr-cli vsepr_sim vsepr_pot vsepr_box vsepr_nl)
    install(TARGETS vsepr-cli DESTINATION bin)
    
    # Viewer (with visualization)
    if(BUILD_VIS)
        add_executable(vsepr-view 
            apps/vsepr-view/main.cpp
        )
        target_link_libraries(vsepr-view 
            vsepr_sim vsepr_pot vsepr_box vsepr_nl vsepr_int vsepr_vis
        )
        install(TARGETS vsepr-view DESTINATION bin)
    endif()
    
    # Unified CLI - main entry point for all features
    set(VSEPR_SOURCES
        apps/cli.cpp
        src/cli/cmd_help.cpp
        src/cli/cmd_version.cpp
        src/cli/cmd_build.cpp
        src/cli/cmd_viz.cpp
        src/cli/cmd_therm.cpp
        src/cli/cmd_webgl.cpp
        src/cli/cmd_stream.cpp
    )
    
    # Add Windows icon resource
    if(WIN32)
        if(EXISTS ${PROJECT_SOURCE_DIR}/resources/vsepr.rc)
            list(APPEND VSEPR_SOURCES ${PROJECT_SOURCE_DIR}/resources/vsepr.rc)
        endif()
    endif()
    
    add_executable(vsepr ${VSEPR_SOURCES})
    target_link_libraries(vsepr vsepr_sim vsepr_pot vsepr_core)
    target_include_directories(vsepr PRIVATE src/ include/)
    
    # Link visualization if available
    if(BUILD_VIS)
        target_link_libraries(vsepr vsepr_vis)
        target_compile_definitions(vsepr PRIVATE BUILD_VISUALIZATION)
    endif()
    
    # Batch runner with DSL/JSON specifications
    add_executable(vsepr_batch apps/vsepr_batch.cpp)
    target_link_libraries(vsepr_batch spec_parser vsepr_core)
    
    # XYZ Suite Tester - Production API validation
    add_executable(xyz_suite_test apps/xyz_suite_test.cpp)
    target_link_libraries(xyz_suite_test vsepr_api vsepr_io vsepr_core)
    target_include_directories(xyz_suite_test PRIVATE include/)
    if(WIN32)
        target_link_libraries(xyz_suite_test psapi)
    endif()
endif()

# ============================================================================
# Tests
# ============================================================================

if(BUILD_TESTS)
    enable_testing()
    
    # Geometry operations
    add_executable(geom_ops_tests tests/geom_ops_tests.cpp)
    target_link_libraries(geom_ops_tests vsepr_core vsepr_sim)
    add_test(NAME GeometryOpsTest COMMAND geom_ops_tests)
    
    # Energy model
    add_executable(energy_tests tests/energy_tests.cpp)
    target_link_libraries(energy_tests vsepr_sim vsepr_pot)
    add_test(NAME EnergyTest COMMAND energy_tests)
    
    # Optimizer
    add_executable(optimizer_tests tests/optimizer_tests.cpp)
    target_link_libraries(optimizer_tests vsepr_sim vsepr_pot)
    add_test(NAME OptimizerTest COMMAND optimizer_tests)
    
    # Angles
    add_executable(angle_tests tests/angle_tests.cpp)
    target_link_libraries(angle_tests vsepr_sim vsepr_pot)
    add_test(NAME AngleTest COMMAND angle_tests)
    
    # VSEPR
    add_executable(vsepr_tests tests/vsepr_tests.cpp)
    target_link_libraries(vsepr_tests vsepr_sim vsepr_pot)
    add_test(NAME VSEPRTest COMMAND vsepr_tests)
    
    # Torsions
    add_executable(torsion_tests tests/torsion_tests.cpp)
    target_link_libraries(torsion_tests vsepr_sim vsepr_pot)
    add_test(NAME TorsionTest COMMAND torsion_tests)
    
    add_executable(torsion_validation_tests tests/torsion_validation_tests.cpp)
    target_link_libraries(torsion_validation_tests vsepr_sim vsepr_pot)
    add_test(NAME TorsionValidationTest COMMAND torsion_validation_tests)
    
    add_executable(alkane_torsion_tests tests/alkane_torsion_tests.cpp)
    target_link_libraries(alkane_torsion_tests vsepr_sim vsepr_pot)
    add_test(NAME AlkaneTorsionTest COMMAND alkane_torsion_tests)
    
    # Scan tests
    add_executable(butane_scan tests/butane_scan.cpp)
    target_link_libraries(butane_scan vsepr_sim vsepr_pot)
    add_test(NAME ButaneScanTest COMMAND butane_scan)
    
    # Domain tests
    add_executable(vsepr_domain_test tests/vsepr_domain_test.cpp)
    target_link_libraries(vsepr_domain_test vsepr_sim vsepr_pot)
    
    # Basic validation tests (post-refactoring)
    add_executable(basic_molecule_validation tests/basic_molecule_validation.cpp)
    target_link_libraries(basic_molecule_validation vsepr_sim vsepr_pot vsepr_core)
    add_test(NAME BasicMoleculeValidation COMMAND basic_molecule_validation)
    
    add_executable(basic_isomer_validation tests/basic_isomer_validation.cpp)
    target_link_libraries(basic_isomer_validation vsepr_sim vsepr_pot vsepr_core)
    add_test(NAME BasicIsomerValidation COMMAND basic_isomer_validation)
    
    # Ethane torsion barrier test (critical for torsion validation)
    add_executable(test_ethane_torsion tests/test_ethane_torsion.cpp)
    target_link_libraries(test_ethane_torsion vsepr_sim vsepr_pot vsepr_core)
    add_test(NAME EthaneTorsionBarrier COMMAND test_ethane_torsion)
    
    add_test(NAME VSEPRDomainTest COMMAND vsepr_domain_test)
    
    # Standalone optimization
    add_executable(vsepr_standalone_opt tests/vsepr_standalone_opt.cpp)
    target_link_libraries(vsepr_standalone_opt vsepr_sim vsepr_pot)
    
    # Energy model v03
    add_executable(energy_model_v03_test tests/energy_model_v03_test.cpp)
    target_link_libraries(energy_model_v03_test vsepr_sim vsepr_pot)
    
    # PBC tests
    add_executable(pbc_test tests/pbc_test.cpp)
    target_link_libraries(pbc_test vsepr_core vsepr_box)
    add_test(NAME PBCTest COMMAND pbc_test)
    
    # PBC verification (Phase 1 technical requirements)
    add_executable(pbc_verification tests/pbc_verification.cpp)
    target_link_libraries(pbc_verification vsepr_core vsepr_box)
    add_test(NAME PBCVerification COMMAND pbc_verification)
    
    # PBC Phase 2 (physics parity tests)
    add_executable(pbc_phase2_physics tests/pbc_phase2_physics.cpp)
    target_link_libraries(pbc_phase2_physics vsepr_core vsepr_box)
    add_test(NAME PBCPhase2Physics COMMAND pbc_phase2_physics)
    
    # Phase 4: Performance baselines
    add_executable(pbc_phase4_perf tests/pbc_phase4_perf.cpp)
    target_link_libraries(pbc_phase4_perf vsepr_core vsepr_box)
    
    # Phase 5: Golden regression tests
    add_executable(pbc_phase5_golden tests/pbc_phase5_golden.cpp)
    target_link_libraries(pbc_phase5_golden vsepr_core vsepr_box)
    add_test(NAME PBCPhase5Golden COMMAND pbc_phase5_golden)
    
    # Formula builder tests (production core API)
    add_executable(formula_builder_tests tests/formula_builder_tests.cpp)
    target_link_libraries(formula_builder_tests vsepr_core vsepr_sim vsepr_build vsepr_pot)
    add_test(NAME FormulaBuilderTests COMMAND formula_builder_tests)
    
    # Conformer finder test
    add_executable(conformer_test tests/conformer_test.cpp)
    target_link_libraries(conformer_test vsepr_core vsepr_sim vsepr_build vsepr_pot)
    add_test(NAME ConformerTest COMMAND conformer_test)
    
    # Isomer enumeration and identification test
    add_executable(isomer_test tests/isomer_test.cpp)
    target_link_libraries(isomer_test vsepr_core vsepr_sim vsepr_build vsepr_pot)
    add_test(NAME IsomerTest COMMAND isomer_test)
    
    # Phase 3: Isomerism validation (cis/trans)
    add_executable(phase3_isomer_validation tests/phase3_isomer_validation.cpp)
    target_link_libraries(phase3_isomer_validation vsepr_core vsepr_pot vsepr_int)
    add_test(NAME Phase3IsomerValidation COMMAND phase3_isomer_validation)
    
    # Phase 4: Coordination geometry variants
    add_executable(phase4_coordination_variants tests/phase4_coordination_variants.cpp)
    target_link_libraries(phase4_coordination_variants vsepr_core vsepr_pot vsepr_int)
    add_test(NAME Phase4CoordinationVariants COMMAND phase4_coordination_variants)
    
    # Phase 5: Ionic manifold testing
    add_executable(phase5_ionic_manifold tests/phase5_ionic_manifold.cpp)
    target_link_libraries(phase5_ionic_manifold vsepr_core vsepr_pot vsepr_int)
    add_test(NAME Phase5IonicManifold COMMAND phase5_ionic_manifold)
    
    # Chemistry basic test (typing & thermodynamics)
    add_executable(chemistry_basic_test tests/chemistry_basic_test.cpp)
    target_link_libraries(chemistry_basic_test vsepr_core)
    add_test(NAME ChemistryBasic COMMAND chemistry_basic_test)
    
    # Chemistry universal test (organic + coordination)
    add_executable(chemistry_universal_test tests/chemistry_universal_test.cpp)
    target_link_libraries(chemistry_universal_test vsepr_core)
    add_test(NAME ChemistryUniversal COMMAND chemistry_universal_test)
    
    # Improved nonbonded parameters test (element-specific LJ)
    add_executable(test_improved_nonbonded tests/test_improved_nonbonded.cpp)
    target_link_libraries(test_improved_nonbonded vsepr_core vsepr_sim vsepr_pot)
    add_test(NAME ImprovedNonbondedTest COMMAND test_improved_nonbonded)
    
    # Spec parser test (DSL & JSON)
    add_executable(test_spec_parser tests/test_spec_parser.cpp)
    target_link_libraries(test_spec_parser spec_parser)
    add_test(NAME SpecParserTest COMMAND test_spec_parser)
    
    # Formula parser test (namespaced, comprehensive)
    add_executable(test_formula_parser tests/test_formula_parser.cpp)
    target_link_libraries(test_formula_parser vsepr_core)
    add_test(NAME FormulaParserTest COMMAND test_formula_parser)
    
    # Formula fuzz tester (intensive automated testing)
    add_executable(formula_fuzz_tester tests/formula_fuzz_tester.cpp)
    target_link_libraries(formula_fuzz_tester vsepr_core)
    
    # Phase 1: Element DB + Manifold Sanity (brutal validation)
    add_executable(test_element_db_phase1_simple tests/test_element_db_phase1_simple.cpp)
    target_link_libraries(test_element_db_phase1_simple vsepr_core)
    add_test(NAME ElementDBPhase1Simple COMMAND test_element_db_phase1_simple)
    
    # Phase 2: Complex Molecules (user workflow simulation)
    add_executable(phase2_complex_molecules tests/phase2_complex_molecules.cpp)
    target_link_libraries(phase2_complex_molecules vsepr_core)
    add_test(NAME Phase2ComplexMolecules COMMAND phase2_complex_molecules)
    
    # PBC example/demo
    add_executable(pbc_example docs/pbc_example.cpp)
    target_link_libraries(pbc_example vsepr_core vsepr_box)
endif()

# PBC Visual Demo
if(BUILD_VIS)
    add_executable(pbc-visual-demo src/pbc_visual_demo.cpp)
    target_link_libraries(pbc-visual-demo 
        vsepr_core vsepr_box 
        OpenGL::GL OpenGL::GLU glfw GLEW::GLEW
    )
    
    # Command Console Demo
    add_executable(command-console-demo examples/demos/command_console_demo.cpp)
    target_link_libraries(command-console-demo 
        vsepr_sim vsepr_pot vsepr_box vsepr_nl vsepr_int vsepr_vis
    )
    target_include_directories(command-console-demo PRIVATE ${CMAKE_SOURCE_DIR}/src)
    
    # Command Parser Test
    add_executable(command_parser_test tests/command_parser_test.cpp)
    target_link_libraries(command_parser_test 
        vsepr_sim vsepr_pot vsepr_box vsepr_nl vsepr_int vsepr_vis
    )
    add_test(NAME CommandParserTest COMMAND command_parser_test)
endif()

# ============================================================================
# Summary
# ============================================================================

message(STATUS "")
message(STATUS "=== VSEPR Simulator Configuration ===")
message(STATUS "Version: ${PROJECT_VERSION}")
message(STATUS "Build tests: ${BUILD_TESTS}")
message(STATUS "Build apps: ${BUILD_APPS}")
message(STATUS "Build visualization: ${BUILD_VIS}")
message(STATUS "")
message(STATUS "Internal Libraries:")
message(STATUS "  - vsepr_core (header-only)")
message(STATUS "  - vsepr_sim (static)")
message(STATUS "  - vsepr_pot (header-only)")
message(STATUS "  - vsepr_box (header-only)")
message(STATUS "  - vsepr_nl (header-only)")
message(STATUS "  - vsepr_int (header-only)")
message(STATUS "  - vsepr_build (header-only - formula→molecule)")
message(STATUS "  - vsepr_io (static - .xyz/.xyzA file I/O)")
message(STATUS "  - vsepr_thermal (static - .xyzC thermal pathways)")
message(STATUS "  - vsepr_api (static - production app-facing façade)")
if(BUILD_VIS)
    message(STATUS "  - vsepr_vis (static)")
endif()
message(STATUS "")
